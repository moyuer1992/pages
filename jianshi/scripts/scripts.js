"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _argumentsToArray(t){return[].concat.apply([],Array.prototype.slice.apply(t))}function radians(t){return t*Math.PI/180}function vec2(){var t=_argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0)}return t.splice(0,2)}function vec3(){var t=_argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0)}return t.splice(0,3)}function vec4(){var t=_argumentsToArray(arguments);switch(t.length){case 0:t.push(0);case 1:t.push(0);case 2:t.push(0);case 3:t.push(1)}return t.splice(0,4)}function mat2(){var t=_argumentsToArray(arguments),e=[];switch(t.length){case 0:t[0]=1;case 1:e=[vec2(t[0],0),vec2(0,t[0])];break;default:e.push(vec2(t)),t.splice(0,2),e.push(vec2(t))}return e.matrix=!0,e}function mat3(){var t=_argumentsToArray(arguments),e=[];switch(t.length){case 0:t[0]=1;case 1:e=[vec3(t[0],0,0),vec3(0,t[0],0),vec3(0,0,t[0])];break;default:e.push(vec3(t)),t.splice(0,3),e.push(vec3(t)),t.splice(0,3),e.push(vec3(t))}return e.matrix=!0,e}function mat4(){var t=_argumentsToArray(arguments),e=[];switch(t.length){case 0:t[0]=1;case 1:e=[vec4(t[0],0,0,0),vec4(0,t[0],0,0),vec4(0,0,t[0],0),vec4(0,0,0,t[0])];break;default:e.push(vec4(t)),t.splice(0,4),e.push(vec4(t)),t.splice(0,4),e.push(vec4(t)),t.splice(0,4),e.push(vec4(t))}return e.matrix=!0,e}function equal(t,e){if(t.length!=e.length)return!1;if(t.matrix&&e.matrix)for(var n=0;n<t.length;++n){if(t[n].length!=e[n].length)return!1;for(var i=0;i<t[n].length;++i)if(t[n][i]!==e[n][i])return!1}else{if(t.matrix&&!e.matrix||!t.matrix&&e.matrix)return!1;for(var n=0;n<t.length;++n)if(t[n]!==e[n])return!1}return!0}function add(t,e){var n=[];if(t.matrix&&e.matrix){if(t.length!=e.length)throw"add(): trying to add matrices of different dimensions";for(var i=0;i<t.length;++i){if(t[i].length!=e[i].length)throw"add(): trying to add matrices of different dimensions";n.push([]);for(var a=0;a<t[i].length;++a)n[i].push(t[i][a]+e[i][a])}return n.matrix=!0,n}if(t.matrix&&!e.matrix||!t.matrix&&e.matrix)throw"add(): trying to add matrix and non-matrix variables";if(t.length!=e.length)throw"add(): vectors are not the same dimension";for(var i=0;i<t.length;++i)n.push(t[i]+e[i]);return n}function subtract(t,e){var n=[];if(t.matrix&&e.matrix){if(t.length!=e.length)throw"subtract(): trying to subtract matrices of different dimensions";for(var i=0;i<t.length;++i){if(t[i].length!=e[i].length)throw"subtract(): trying to subtact matrices of different dimensions";n.push([]);for(var a=0;a<t[i].length;++a)n[i].push(t[i][a]-e[i][a])}return n.matrix=!0,n}if(t.matrix&&!e.matrix||!t.matrix&&e.matrix)throw"subtact(): trying to subtact  matrix and non-matrix variables";if(t.length!=e.length)throw"subtract(): vectors are not the same length";for(var i=0;i<t.length;++i)n.push(t[i]-e[i]);return n}function mult(t,e){var n=[];if(t.matrix&&e.matrix){if(t.length!=e.length)throw"mult(): trying to add matrices of different dimensions";for(var i=0;i<t.length;++i)if(t[i].length!=e[i].length)throw"mult(): trying to add matrices of different dimensions";for(var i=0;i<t.length;++i){n.push([]);for(var a=0;a<e.length;++a){for(var r=0,o=0;o<t.length;++o)r+=t[i][o]*e[o][a];n[i].push(r)}}return n.matrix=!0,n}if(t.matrix&&t.length==e.length){for(var i=0;i<e.length;i++){for(var r=0,a=0;a<e.length;a++)r+=t[i][a]*e[a];n.push(r)}return n}if(t.length!=e.length)throw"mult(): vectors are not the same dimension";for(var i=0;i<t.length;++i)n.push(t[i]*e[i]);return n}function translate(t,e,n){Array.isArray(t)&&3==t.length&&(n=t[2],e=t[1],t=t[0]);var i=mat4();return i[0][3]=t,i[1][3]=e,i[2][3]=n,i}function rotate(t,e){Array.isArray(e)||(e=[arguments[1],arguments[2],arguments[3]]);var n=normalize(e),i=n[0],a=n[1],r=n[2],o=Math.cos(radians(t)),s=1-o,h=Math.sin(radians(t)),c=mat4(vec4(i*i*s+o,i*a*s-r*h,i*r*s+a*h,0),vec4(i*a*s+r*h,a*a*s+o,a*r*s-i*h,0),vec4(i*r*s-a*h,a*r*s+i*h,r*r*s+o,0),vec4());return c}function rotateX(t){var e=Math.cos(radians(t)),n=Math.sin(radians(t)),i=mat4(1,0,0,0,0,e,n,0,0,-n,e,0,0,0,0,1);return i}function rotateY(t){var e=Math.cos(radians(t)),n=Math.sin(radians(t)),i=mat4(e,0,-n,0,0,1,0,0,n,0,e,0,0,0,0,1);return i}function rotateZ(t){var e=Math.cos(radians(t)),n=Math.sin(radians(t)),i=mat4(e,n,0,0,-n,e,0,0,0,0,1,0,0,0,0,1);return i}function scalem(t,e,n){Array.isArray(t)&&3==t.length&&(n=t[2],e=t[1],t=t[0]);var i=mat4();return i[0][0]=t,i[1][1]=e,i[2][2]=n,i}function lookAt(t,e,n){if(!Array.isArray(t)||3!=t.length)throw"lookAt(): first parameter [eye] must be an a vec3";if(!Array.isArray(e)||3!=e.length)throw"lookAt(): first parameter [at] must be an a vec3";if(!Array.isArray(n)||3!=n.length)throw"lookAt(): first parameter [up] must be an a vec3";if(equal(t,e))return mat4();var i=normalize(subtract(e,t)),a=normalize(cross(i,n)),r=normalize(cross(a,i));i=negate(i);var o=mat4(vec4(a,-dot(a,t)),vec4(r,-dot(r,t)),vec4(i,-dot(i,t)),vec4());return o}function ortho(t,e,n,i,a,r){if(t==e)throw"ortho(): left and right are equal";if(n==i)throw"ortho(): bottom and top are equal";if(a==r)throw"ortho(): near and far are equal";var o=e-t,s=i-n,h=r-a,c=mat4();return c[0][0]=2/o,c[1][1]=2/s,c[2][2]=-2/h,c[0][3]=-(t+e)/o,c[1][3]=-(i+n)/s,c[2][3]=-(a+r)/h,c}function perspective(t,e,n,i){var a=1/Math.tan(radians(t)/2),r=i-n,o=mat4();return o[0][0]=a/e,o[1][1]=a,o[2][2]=-(n+i)/r,o[2][3]=-2*n*i/r,o[3][2]=-1,o[3][3]=0,o}function transpose(t){if(!t.matrix)return"transpose(): trying to transpose a non-matrix";for(var e=[],n=0;n<t.length;++n){e.push([]);for(var i=0;i<t[n].length;++i)e[n].push(t[i][n])}return e.matrix=!0,e}function dot(t,e){if(t.length!=e.length)throw"dot(): vectors are not the same dimension";for(var n=0,i=0;i<t.length;++i)n+=t[i]*e[i];return n}function negate(t){for(var e=[],n=0;n<t.length;++n)e.push(-t[n]);return e}function cross(t,e){if(!Array.isArray(t)||t.length<3)throw"cross(): first argument is not a vector of at least 3";if(!Array.isArray(e)||e.length<3)throw"cross(): second argument is not a vector of at least 3";var n=[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]];return n}function length(t){return Math.sqrt(dot(t,t))}function normalize(t,e){if(e)var n=t.pop();var i=length(t);if(!isFinite(i))throw"normalize: vector "+t+" has zero length";for(var a=0;a<t.length;++a)t[a]/=i;return e&&t.push(n),t}function mix(t,e,n){if("number"!=typeof n)throw"mix: the last paramter "+n+" must be a number";if(t.length!=e.length)throw"vector dimension mismatch";for(var i=[],a=0;a<t.length;++a)i.push((1-n)*t[a]+n*e[a]);return i}function scale(t,e){if(!Array.isArray(e))throw"scale: second parameter "+e+" is not a vector";for(var n=[],i=0;i<e.length;++i)n.push(t*e[i]);return n}function flatten(t){t.matrix===!0&&(t=transpose(t));var e=t.length,n=!1;Array.isArray(t[0])&&(n=!0,e*=t[0].length);var i=new Float32Array(e);if(n)for(var a=0,r=0;r<t.length;++r)for(var o=0;o<t[r].length;++o)i[a++]=t[r][o];else for(var r=0;r<t.length;++r)i[r]=t[r];return i}function printm(t){if(2==t.length)for(var e=0;e<t.length;e++)console.log(t[e][0],t[e][1]);else if(3==t.length)for(var e=0;e<t.length;e++)console.log(t[e][0],t[e][1],t[e][2]);else if(4==t.length)for(var e=0;e<t.length;e++)console.log(t[e][0],t[e][1],t[e][2],t[e][3])}function det2(t){return t[0][0]*t[1][1]-t[0][1]*t[1][0]}function det3(t){var e=t[0][0]*t[1][1]*t[2][2]+t[0][1]*t[1][2]*t[2][0]+t[0][2]*t[2][1]*t[1][0]-t[2][0]*t[1][1]*t[0][2]-t[1][0]*t[0][1]*t[2][2]-t[0][0]*t[1][2]*t[2][1];return e}function det4(t){var e=[vec3(t[1][1],t[1][2],t[1][3]),vec3(t[2][1],t[2][2],t[2][3]),vec3(t[3][1],t[3][2],t[3][3])],n=[vec3(t[1][0],t[1][2],t[1][3]),vec3(t[2][0],t[2][2],t[2][3]),vec3(t[3][0],t[3][2],t[3][3])],i=[vec3(t[1][0],t[1][1],t[1][3]),vec3(t[2][0],t[2][1],t[2][3]),vec3(t[3][0],t[3][1],t[3][3])],a=[vec3(t[1][0],t[1][1],t[1][2]),vec3(t[2][0],t[2][1],t[2][2]),vec3(t[3][0],t[3][1],t[3][2])];return t[0][0]*det3(e)-t[0][1]*det3(n)+t[0][2]*det3(i)-t[0][3]*det3(a)}function det(t){return 1!=t.matrix&&console.log("not a matrix"),2==t.length?det2(t):3==t.length?det3(t):4==t.length?det4(t):void 0}function inverse2(t){var e=mat2(),n=det2(t);return e[0][0]=t[1][1]/n,e[0][1]=-t[0][1]/n,e[1][0]=-t[1][0]/n,e[1][1]=t[0][0]/n,e.matrix=!0,e}function inverse3(t){var e=mat3(),n=det3(t),i=[vec2(t[1][1],t[1][2]),vec2(t[2][1],t[2][2])],a=[vec2(t[1][0],t[1][2]),vec2(t[2][0],t[2][2])],r=[vec2(t[1][0],t[1][1]),vec2(t[2][0],t[2][1])],o=[vec2(t[0][1],t[0][2]),vec2(t[2][1],t[2][2])],s=[vec2(t[0][0],t[0][2]),vec2(t[2][0],t[2][2])],h=[vec2(t[0][0],t[0][1]),vec2(t[2][0],t[2][1])],c=[vec2(t[0][1],t[0][2]),vec2(t[1][1],t[1][2])],l=[vec2(t[0][0],t[0][2]),vec2(t[1][0],t[1][2])],u=[vec2(t[0][0],t[0][1]),vec2(t[1][0],t[1][1])];return e[0][0]=det2(i)/n,e[0][1]=-det2(o)/n,e[0][2]=det2(c)/n,e[1][0]=-det2(a)/n,e[1][1]=det2(s)/n,e[1][2]=-det2(l)/n,e[2][0]=det2(r)/n,e[2][1]=-det2(h)/n,e[2][2]=det2(u)/n,e}function inverse4(t){var e=mat4(),n=det4(t),i=[vec3(t[1][1],t[1][2],t[1][3]),vec3(t[2][1],t[2][2],t[2][3]),vec3(t[3][1],t[3][2],t[3][3])],a=[vec3(t[1][0],t[1][2],t[1][3]),vec3(t[2][0],t[2][2],t[2][3]),vec3(t[3][0],t[3][2],t[3][3])],r=[vec3(t[1][0],t[1][1],t[1][3]),vec3(t[2][0],t[2][1],t[2][3]),vec3(t[3][0],t[3][1],t[3][3])],o=[vec3(t[1][0],t[1][1],t[1][2]),vec3(t[2][0],t[2][1],t[2][2]),vec3(t[3][0],t[3][1],t[3][2])],s=[vec3(t[0][1],t[0][2],t[0][3]),vec3(t[2][1],t[2][2],t[2][3]),vec3(t[3][1],t[3][2],t[3][3])],h=[vec3(t[0][0],t[0][2],t[0][3]),vec3(t[2][0],t[2][2],t[2][3]),vec3(t[3][0],t[3][2],t[3][3])],c=[vec3(t[0][0],t[0][1],t[0][3]),vec3(t[2][0],t[2][1],t[2][3]),vec3(t[3][0],t[3][1],t[3][3])],l=[vec3(t[0][0],t[0][1],t[0][2]),vec3(t[2][0],t[2][1],t[2][2]),vec3(t[3][0],t[3][1],t[3][2])],u=[vec3(t[0][1],t[0][2],t[0][3]),vec3(t[1][1],t[1][2],t[1][3]),vec3(t[3][1],t[3][2],t[3][3])],f=[vec3(t[0][0],t[0][2],t[0][3]),vec3(t[1][0],t[1][2],t[1][3]),vec3(t[3][0],t[3][2],t[3][3])],d=[vec3(t[0][0],t[0][1],t[0][3]),vec3(t[1][0],t[1][1],t[1][3]),vec3(t[3][0],t[3][1],t[3][3])],v=[vec3(t[0][0],t[0][1],t[0][2]),vec3(t[1][0],t[1][1],t[1][2]),vec3(t[3][0],t[3][1],t[3][2])],g=[vec3(t[0][1],t[0][2],t[0][3]),vec3(t[1][1],t[1][2],t[1][3]),vec3(t[2][1],t[2][2],t[2][3])],p=[vec3(t[0][0],t[0][2],t[0][3]),vec3(t[1][0],t[1][2],t[1][3]),vec3(t[2][0],t[2][2],t[2][3])],x=[vec3(t[0][0],t[0][1],t[0][3]),vec3(t[1][0],t[1][1],t[1][3]),vec3(t[2][0],t[2][1],t[2][3])],m=[vec3(t[0][0],t[0][1],t[0][2]),vec3(t[1][0],t[1][1],t[1][2]),vec3(t[2][0],t[2][1],t[2][2])];return e[0][0]=det3(i)/n,e[0][1]=-det3(s)/n,e[0][2]=det3(u)/n,e[0][3]=-det3(g)/n,e[1][0]=-det3(a)/n,e[1][1]=det3(h)/n,e[1][2]=-det3(f)/n,e[1][3]=det3(p)/n,e[2][0]=det3(r)/n,e[2][1]=-det3(c)/n,e[2][2]=det3(d)/n,e[2][3]=-det3(x)/n,e[3][0]=-det3(o)/n,e[3][1]=det3(l)/n,e[3][2]=-det3(v)/n,e[3][3]=det3(m)/n,e}function inverse(t){return 1!=t.matrix&&console.log("not a matrix"),2==t.length?inverse2(t):3==t.length?inverse3(t):4==t.length?inverse4(t):void 0}function normalMatrix(t,e){var n=mat4();if(n=inverse(transpose(t)),1!=e)return n;for(var i=mat3(),a=0;a<3;a++)for(var r=0;r<3;r++)i[a][r]=n[a][r];return i}function calTriangleArea(t,e,n){var i=distance(t,e),a=distance(e,n),r=distance(n,t),o=(i+a+r)/2;return Math.sqrt(o*(o-i)+(o-a)+(o-r))}function distance(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1])+(t[2]-e[2])*(t[2]-e[2]))}function makeTextData(t,e,n){var i=[],a=[],r=[],o=[],s=[],h=[],c=[],l=0,u=e,f=e;textCtx.canvas.width=u,textCtx.canvas.height=f;var d=textCtx;d.clearRect(0,0,d.canvas.width,d.canvas.height),d.font=e+"px "+(n.font||"隶书"),d.fillStyle="black",d.strokeStyle="black",d.lineWidth=1,d.textAlign="center",d.textBaseline="middle",d.fillText(t,u/2,f/2);for(var v=d.getImageData(0,0,d.canvas.width,d.canvas.height),g=v.data,p=1,x=function(t,e,n,s,h){i.push(t),i.push(e),i.push(n),o.push(s),o.push(s),o.push(s);var c=cross(subtract(e,t),subtract(n,t));if(a.push(vec4(c[0],c[1],c[2],0)),a.push(vec4(c[0],c[1],c[2],0)),a.push(vec4(c[0],c[1],c[2],0)),h)switch(h.colorStyle){case"test":var s=h.index,l=(h.n,calTriangleArea(t,e,n)),u=vec4(0,0,0,l>100?1:Math.pow(l/100,.5));r.push(u),r.push(u),r.push(u)}},m=function(t,e){return!(e<0||t<0)&&!!g[4*(t*d.canvas.width+e)+3]},y=function(t,e){var n=0;return n=e>0&&m(t,e-1)?h[t][e-1]:++l,t>0&&m(t-1,e)&&(0===e||!m(t-1,e-1))&&h[t-1][e]!==n&&c.push([h[t-1][e],n]),m(t,e-1)||m(t-1,e-1)&&h[t-1][e-1]!==n&&c.push([h[t-1][e-1],n]),m(t,e+1)||m(t-1,e+1)&&h[t-1][e+1]!==n&&c.push([h[t-1][e+1],n]),n},b=0;b<d.canvas.height;b+=p){h.push([]),s.push([]);for(var w=0;w<d.canvas.width;w+=p){var S=0,C=!1;m(b,w)&&(S=y(b,w)),s[b][w]=C,h[b][w]=S}}var k=seperateGraph(h,s,c,l),T=(k[0],k[2]),_=[],A=n.thick/2,M=-A;return T.forEach(function(t,e){for(var n=t[0],a=t[1],r=earcut(flatten(n),a),o=(n.length,0);o<r.length;o+=3){var s=n[r[o]],h=n[r[o+1]],c=n[r[o+2]];x(vec3(s[0],s[1],A),vec3(h[0],h[1],A),vec3(c[0],c[1],A),e),x(vec3(s[0],s[1],M),vec3(h[0],h[1],M),vec3(c[0],c[1],M),e)}var l=[],u=0;if(a.length)for(var f=0;f<a.length;f++)l.push([u,a[f]-1]),u=a[f];l.push([u,n.length-1]);for(var d=0;d<l.length;d++){for(var v=l[d][0],g=l[d][1],p=v;p<g;p++)x(vec3(n[p][0],n[p][1],A),vec3(n[p][0],n[p][1],M),vec3(n[p+1][0],n[p+1][1],A),e),x(vec3(n[p][0],n[p][1],M),vec3(n[p+1][0],n[p+1][1],M),vec3(n[p+1][0],n[p+1][1],A),e);x(vec3(n[v][0],n[v][1],A),vec3(n[v][0],n[v][1],M),vec3(n[g][0],n[g][1],A),e),x(vec3(n[v][0],n[v][1],M),vec3(n[g][0],n[g][1],M),vec3(n[g][0],n[g][1],A),e)}_.push(i.length)}),[i,a,r,o,_]}function seperateGraph(t,e,n,i){for(var a=[],r=[],o=[],s=[],h=[],c=[],l=0;l<i;l++)s[l]=l;var u=function S(t){return s[t]===t?t:(s[t]=S(s[t]),s[t])};for(l=0;l<n.length;l++){var f=n[l][0],d=n[l][1],v=u(f),g=u(d);v!==g&&(s[g]=v)}for(l=1;l<s.length;l++){var p=u(s[l]),x=h.indexOf(p);x!==-1?c[x].push(l):(h.push(p),c.push([l]))}for(l=0;l<c.length;l++)a.push([]),r.push([]);for(var m=0;m<t.length;m++)for(l=0;l<t[m].length;l++)for(var y=t[m][l],b=0;b<c.length;b++)if(c[b].indexOf(y)!==-1){t[m][l]=b+1;var w=[l,m];a[b].push(w),e[m][l]&&r[b].push(w)}return a.forEach(function(n,i){o.push(orderEdge(t,e,i,0))}),[a,r,o]}function findOuterContourEntry(t,e){for(var n=[-1,-1],i=0;i<t.length;i++)for(var a=0;a<t[0].length;a++)if(t[i][a]===e)return n=[a,i];return n}function findInnerContourEntry(t,e,n){for(var i=!1,a=0;a<t.length;a++)for(var r=0;r<t[0].length;r++)if(t[a][r]===e&&t[a+1]&&0===t[a+1][r]){var o=!1;if("number"==typeof n[a][r]&&(o=!0),!o)return i=[r,a]}return i}function orderEdge(t,e,n,i){n++;var a=[],r=[],o=findOuterContourEntry(t,n),s=o,h=!1;a.push(o),r.push(6);var c,l=[],u=2;e[o[1]][o[0]]=u;for(var f=function(i,r){return!(i<0||i>=t[0].length||r<0||r>=t.length)&&(t[r][i]===n&&!x&&(e[r][i]=u,x=[i,r],a.push(x),c=!0,!0))},d=[function(t,e){return{i:t+1,j:e}},function(t,e){return{i:t+1,j:e+1}},function(t,e){return{i:t,j:e+1}},function(t,e){return{i:t-1,j:e+1}},function(t,e){return{i:t-1,j:e}},function(t,e){return{i:t-1,j:e-1}},function(t,e){return{i:t,j:e-1}},function(t,e){return{i:t+1,j:e-1}}],v=function(t){var e=[4,5,6,7,0,1,2,3];return e[t]};!h;){for(var g=s[0],p=s[1],x=null,m=r[r.length-1],y=0;y<8;y++){var b=(m+1+y)%8,w=f(d[b](g,p).i,d[b](g,p).j);if(w){m=v(b);break}}if(x){if(s=x,s[0]===o[0]&&s[1]===o[1]){var S=findInnerContourEntry(t,n,e);S?(s=o=S,e[o[1]][o[0]]=u,a.push(s),r.push(m),m=2,l.push(a.length-1),u++):h=!0}}else a.splice(a.length-1,1),m=v(r.splice(r.length-1,1)[0]),s=a[a.length-1];r.push(m)}return[a,l]}function convertCanvasToGl(t,e,n,i){return vec3((t-i/2)/i,(i/2-e)/i,n)}function convertCanvasToGl2D(t,e,n){return vec2((t-n/2)/n,(n/2-e)/n)}function parseArr(t,e){for(var n=t[0],i=t[1],a=t[2],r=0;r<n.length;r++)n[r]=convertCanvasToGl(n[r][0],n[r][1],n[r][2],e);return[n,i,a,t[3],t[4]]}function hslToRgb(t,e,n){var i,a,r;if(0==e)i=a=r=n;else{var o=function(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(e-t)*n:n<.5?e:n<2/3?t+(e-t)*(2/3-n)*6:t},s=n<.5?n*(1+e):n+e-n*e,h=2*n-s;i=o(h,s,t+1/3),a=o(h,s,t),r=o(h,s,t-1/3)}return[Math.round(255*i),Math.round(255*a),Math.round(255*r)]}function rgbToHsl(t,e,n){t/=255,e/=255,n/=255;var i,a,r=Math.max(t,e,n),o=Math.min(t,e,n),s=(r+o)/2;if(r==o)i=a=0;else{var h=r-o;switch(a=s>.5?h/(2-r-o):h/(r+o),r){case t:i=(e-n)/h+(e<n?6:0);break;case e:i=(n-t)/h+2;break;case n:i=(t-e)/h+4}i/=6}return[i,a,s]}function componentToHex(t){var e=t.toString(16);return 1==e.length?"0"+e:e}function rgbToHex(t,e,n){return"#"+componentToHex(t)+componentToHex(e)+componentToHex(n)}function hexToRgb(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}var _get=function t(e,n,i){null===e&&(e=Function.prototype);var a=Object.getOwnPropertyDescriptor(e,n);if(void 0===a){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,n,i)}if("value"in a)return a.value;var o=a.get;if(void 0!==o)return o.call(i)},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),sizeof={vec2:new Float32Array(flatten(vec2())).byteLength,vec3:new Float32Array(flatten(vec3())).byteLength,vec4:new Float32Array(flatten(vec4())).byteLength,mat2:new Float32Array(flatten(mat2())).byteLength,mat3:new Float32Array(flatten(mat3())).byteLength,mat4:new Float32Array(flatten(mat4())).byteLength};!function(t){t.fn.classes=function(e){var n=[];if(t.each(this,function(t,e){for(var i=e.className.split(/\s+/),a=0;a<i.length;a++){var r=i[a];-1===n.indexOf(r)&&n.push(r)}}),"function"==typeof e)for(var i in n)e(n[i]);return n}}(jQuery);var initGlProgram=function(t,e){for(var n=t.createProgram(),i=0;i<e.length;i+=1)t.attachShader(n,e[i]);return t.linkProgram(n),t.getProgramParameter(n,t.LINK_STATUS)?n:(window.console.error("failed to link: "+t.getProgramInfoLog(n)),null)},initGlShader=function(t,e,n){var i=t.createShader(n);return t.shaderSource(i,e),t.compileShader(i),i},BgSprite=function(){function t(e){_classCallCheck(this,t),this.map=e.map,this.style=e.style,this.editor=e,this.animating=!1,this.options={timeGap:100,duration:1e3,entryLength:100},this.width=this.editor.canvasNode.width,this.height=this.editor.canvasNode.height,this.ctx=this.editor.bgCtx,this.gl=this.editor.bgGl,this._t=0,this.init()}return _createClass(t,[{key:"init",value:function(){}},{key:"update",value:function(){this.map=this.editor.map,this.style=this.editor.style,this.width=this.editor.canvasNode.width,this.height=this.editor.canvasNode.height,this.ctx=this.editor.bgCtx,this.gl=this.editor.bgGl}},{key:"drawStatic",value:function(){}},{key:"drawFrame",value:function(){}},{key:"advance",value:function(t){var e=!0;return e}},{key:"clear",value:function(){}}]),t}(),TextSprite=function(){function t(e,n){_classCallCheck(this,t),this.map=e.map,this.style=e.style,this.editor=e,this.animating=!1,this.textStyle=1,this.options=n||{timeGap:100,duration:2e3,entryLength:100},this.ctx=this.editor.ctx,this.gl=this.editor.gl,this.animationStyle=0,this._t=0,this.init()}return _createClass(t,[{key:"init",value:function(){this.clearArea=[0,0,this.editor.ctx.canvas.width,this.editor.ctx.canvas.height]}},{key:"changeOptions",value:function(t){Object.keys(t).forEach(function(e){this.options[e]=t[e]})}},{key:"changeTextStyle",value:function(t){this.textStyle=t}},{key:"update",value:function(){this.map=this.editor.map,this.style=this.editor.style,this.startTime=Date.now()}},{key:"drawStatic",value:function(){}},{key:"drawFrame",value:function(){}},{key:"advance",value:function(t){var e=!0;return e&&this.stop(),e}},{key:"stop",value:function(){this._t=0,this.animating=!1}},{key:"getAnimationMap",value:function(){return this.animationMap||(this.animationMap=[{label:"无",value:0}]),this.animationMap}},{key:"clear",value:function(t){if(t){if(!this.clearArea.length)return;this.editor.ctx.clearRect(this.clearArea[0],this.clearArea[1],this.clearArea[2],this.clearArea[3])}this.editor.ctx.clearRect(0,0,this.editor.ctx.canvas.width,this.editor.ctx.canvas.height)}}]),t}(),util={hexToRgb:function(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null},rgbToHex:function(t,e,n){function i(t){var e=t.toString(16);return 1==e.length?"0"+e:e}return"#"+i(t)+i(e)+i(n)},getSpriteEntity:function(){var entities=[];return function(className,editor){var Klass=eval(className);return entities[className]?entities[className]:entities[className]=new Klass(editor)}}(),getInitialState:function(t){return config[t+"Map"][config.state[t+"Index"]].value}},config={fontMap:[{label:"隶书",value:"STBaoliSC-Regular"},{label:"楷体",value:"STKaiti"},{label:"魏碑",value:"Weibei-SC-Bold"},{label:"隶变",value:"STLibianSC-Regular"},{label:"娃娃体",value:"DFWaWaSC-W5"},{label:"行楷",value:"STXingkaiSC-Bold"}],fontSizeMap:[{label:"小",value:30},{label:"中",value:40},{label:"大",value:50}],fontColorMap:[{label:"黑",value:"#000000"},{label:"白",value:"#FFFFFF"},{label:"褐",value:"#514848"}],textStyleMap:[{Klass:"GlTextSprite",style:1,label:"渲墨",value:0},{Klass:"GlTextSprite",style:2,label:"立体",value:1}],textAlignMap:[{label:"居中",value:"center"},{label:"左对齐",value:"left"}],backgroundMap:[{Klass:"PureBgSprite",label:"纯色",value:0,colors:["rgb(235, 235, 235)","#FEFEFE","#3a3a3a"]},{Klass:"TreeBgSprite",label:"月下林间",value:1,colors:["rgb(235, 235, 235)","#b1a69b","#3a3a3a"]}],animationMap:[{label:"无",value:0},{label:"粒子缓入",value:1}],state:{fontIndex:0,fontSizeIndex:0,fontColorIndex:0,textStyleIndex:0,textAlignIndex:0,backgroundIndex:0,animationIndex:1,bgColorIndex:0}},textCtx=document.createElement("canvas").getContext("2d"),GlTextSprite=function(t){function e(t,n){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n))}return _inherits(e,t),_createClass(e,[{key:"init",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"init",this).call(this),this.canvas=this.editor.glcanvasNode,this.dataMap={},this.initGl()}},{key:"update",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this),this._finish=!1,this.clearArea=[0,0,this.canvas.width,this.canvas.height]}},{key:"parseData",value:function(){for(var t=this.map,e=0;e<t.length;e++)for(var n=0;n<t[e].length;n++)if(t[e][n]["char"]&&" "!==t[e][n]["char"]){var i=this.getTextData(t[e][n]["char"]);t[e][n].data=i}}},{key:"getTextData",value:function(t){var e,n=this.style.font;if(this.dataMap[n]||(this.dataMap[n]={}),Object.keys(this.dataMap[n]).indexOf(t)===-1){var i=200;e=makeTextData(t,i,{thick:.1,font:n}),e=parseArr(e,i),this.dataMap[n][t]=e}else e=this.dataMap[n][t];return e}},{key:"drawStatic",value:function(){var t=(this.editor.ctx,this.map);this.parseData(),this.clear();for(var e=0;e<t.length;e++)for(var n=0;n<t[e].length;n++)if(t[e][n]["char"]&&" "!==t[e][n]["char"]){var i=t[e][n].data;this.renderGlText(i,{pos:{x:t[e][n].x+this.editor.style.fontSize/2,y:t[e][n].y+this.style.lineHeight()/2},fontSize:this.style.fontSize,fontColor:this.style.fontColor,textStyle:this.textStyle,t:1})}}},{key:"drawFrame",value:function(){switch(this.style.animation){case 0:var t=this.map,e=this.editor.style.fontSize,n=(this.gl,!0);this.clear(!0);for(var i=0;i<t.length;i++)for(var a=0;a<t[i].length;a++)if(t[i][a]["char"]&&" "!==t[i][a]["char"]){var r=t[i][a].data,o=this.t,s=0;if(Math.floor(o/1e3)<i?(t[i][a].finish=-1,n=!1):Math.floor(o/1e3)===i?(t[i][a].finish=0,n=!1,s=o%1e3/1e3):Math.floor(o/1e3)>i&&(s=1,t[i][a].finish?(t[i][a].finish+=1,this.clearArea=[0,0,this.canvas.width,this.canvas.height-(t[i][a].y+this.style.lineHeight())]):(n=!1,t[i][a].finish=1)),t[i][a].finish>=0&&t[i][a].finish<=2){var h={x:t[i][a].x+this.editor.style.fontSize/2,y:t[i][a].y+this.style.lineHeight()/2};this.renderGlText(r,{pos:h,fontSize:e,fontColor:this.style.fontColor,textStyle:this.textStyle,t:s})}}this._finish=n;break;case 1:this.drawStatic()}}},{key:"advance",value:function(t){var e=!1;switch(this.t=t,this.style.animation){case 0:e=this._finish;break;case 1:e=!0}return e&&this.stop(),e}},{key:"stop",value:function(){this._t=0,this.animating=!1,this.clearArea=[0,0,this.canvas.width,this.canvas.height]}},{key:"getAnimationMap",value:function(){return this.animationMap||(this.animationMap=[{label:"纵横捭阖",value:0},{label:"无",value:1}]),this.animationMap}},{key:"initGl",value:function(){var t=this.gl;this.vertexShader=initGlShader(t,"attribute vec3 vPosition;\n      attribute vec4 vNormal;\n      attribute float compIdx;\n\n      varying vec4 fColor;\n\n      uniform float t;\n      uniform float compNum;\n      uniform int style;\n      uniform vec3 vColor;\n\n      uniform vec4 ambientProduct, diffuseProduct, specularProduct;\n      uniform mat4 modelViewMatrix;\n      uniform mat4 projectionMatrix;\n      uniform vec4 lightPosition;\n      uniform float shininess;\n      uniform mat3 normalMatrix;\n\n      void main() {\n        float n = (1.0 - t) * pow((1.0 + compIdx) / compNum, 2.0);\n        float xx = vPosition.x - vPosition.x * pow(n, 0.5);\n        float yy = vPosition.y - 2.0 * vPosition.y * pow(n, 2.0);\n        float zz = vPosition.z - pow(n, 0.5);\n        float ww = 1.0;\n        \n        vec4 aPosition = vec4(xx, yy, zz, ww);\n        vec3 pos = (modelViewMatrix * aPosition).xyz;\n\n        vec3 L;\n        \n        if(lightPosition.w == 0.0) \n          L = normalize(lightPosition.xyz);\n        else \n          L = normalize( lightPosition.xyz - pos );\n\n        vec3 E = -normalize( pos );\n        vec3 H = normalize( L + E );\n        vec3 N = normalize( normalMatrix*vNormal.xyz);\n\n        vec4 ambient = vec4(vColor, 1.0);\n\n        float Kd = max( dot(L, N), 0.0 );\n        vec4  diffuse = Kd*diffuseProduct;\n\n        float Ks = pow( max(dot(N, H), 0.0), shininess );\n        vec4  specular = Ks * specularProduct;\n        \n        if( dot(L, N) < 0.0 ) {\n          specular = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n\n        gl_PointSize = 1.0;\n        gl_Position = projectionMatrix * modelViewMatrix * aPosition;\n\n        if (style == 1) {\n          if (dot(N, L) < 0.0) {\n            fColor = vec4(vColor, 1.0);\n          } else if (dot(N, L) < 0.8) {\n            fColor = vec4(0.0, 0.0, 0.0, 0.0);\n          } else {\n            fColor = vec4(vColor, 1.0);\n          }\n        } else if (style == 2) {\n          fColor = ambient + diffuse +specular;\n        }\n      }",t.VERTEX_SHADER),this.fragmentShader=initGlShader(t,"precision mediump float;\n\n      varying vec4 fColor;\n\n      void main() {\n        gl_FragColor = fColor;\n      }",t.FRAGMENT_SHADER),this.program=initGlProgram(t,[this.vertexShader,this.fragmentShader])}},{key:"renderGlText",value:function(t,e){var n=e.pos,i=e.fontSize,a=hexToRgb(e.fontColor),r=e.textStyle;a=vec3(a.r/255,a.g/255,a.b/255);var o=e.t;if(0!==o){var s,h,c,l,u,f,d,v=this.gl,g=this.program,p=[],x=[],m=[],y=[],b=-.8,w=.8,S=.1,C=.7,k=.1,T=-.8,_=.8,A=.8,M=-.8,I=vec4(1,1,1,0),$=vec4(.5,.5,.5,1),R=vec4(1,1,1,1),E=vec4(1,1,1,1),B=vec4(.5,.5,.5,1),P=vec4(.7,.7,.7,1),N=vec4(1,1,1,1),F=20,L=vec3(0,0,0),H=vec3(0,1,0);v.useProgram(g),v.enable(v.DEPTH_TEST),v.viewport(n.x-i,this.canvas.height-n.y-i,2*i,2*i);var t,z=mult($,B),D=mult(R,P),G=mult(E,N);p=t[0],x=t[1],m=t[2];var y=t[3],O=t[4],U=v.createBuffer();v.bindBuffer(v.ARRAY_BUFFER,U),v.bufferData(v.ARRAY_BUFFER,flatten(x),v.STATIC_DRAW);var j=v.getAttribLocation(g,"vNormal");v.vertexAttribPointer(j,4,v.FLOAT,!1,0,0),v.enableVertexAttribArray(j);var Y=v.createBuffer();v.bindBuffer(v.ARRAY_BUFFER,Y),v.bufferData(v.ARRAY_BUFFER,flatten(p),v.STATIC_DRAW);var Z=v.getAttribLocation(g,"vPosition");v.vertexAttribPointer(Z,3,v.FLOAT,!1,0,0),v.enableVertexAttribArray(Z);var W=v.createBuffer();v.bindBuffer(v.ARRAY_BUFFER,W),v.bufferData(v.ARRAY_BUFFER,flatten(y),v.STATIC_DRAW);var K=v.getAttribLocation(g,"compIdx");v.vertexAttribPointer(K,1,v.FLOAT,!1,0,0),v.enableVertexAttribArray(K),c=v.getUniformLocation(g,"modelViewMatrix"),l=v.getUniformLocation(g,"projectionMatrix"),f=v.getUniformLocation(g,"normalMatrix"),v.uniform4fv(v.getUniformLocation(g,"ambientProduct"),flatten(z)),v.uniform4fv(v.getUniformLocation(g,"diffuseProduct"),flatten(D)),v.uniform4fv(v.getUniformLocation(g,"specularProduct"),flatten(G)),v.uniform4fv(v.getUniformLocation(g,"lightPosition"),flatten(I)),v.uniform1f(v.getUniformLocation(g,"shininess"),F),v.uniform1f(v.getUniformLocation(g,"compNum"),O.length),v.uniform1f(v.getUniformLocation(g,"t"),o),v.uniform1i(v.getUniformLocation(g,"style"),r),v.uniform3fv(v.getUniformLocation(g,"vColor"),flatten(a)),d=vec3(S*Math.sin(C)*Math.cos(k),S*Math.sin(C)*Math.sin(k),S*Math.cos(C)),s=lookAt(d,L,H),h=ortho(T,_,M,A,b,w),u=[vec3(s[0][0],s[0][1],s[0][2]),vec3(s[1][0],s[1][1],s[1][2]),vec3(s[2][0],s[2][1],s[2][2])],v.uniformMatrix4fv(c,!1,flatten(s)),v.uniformMatrix4fv(l,!1,flatten(h)),v.uniformMatrix3fv(f,!1,flatten(u)),v.drawArrays(v.TRIANGLES,0,p.length)}}},{key:"clear",value:function(t){var e=this.gl;if(t){if(!this.clearArea.length)return;e.enable(e.SCISSOR_TEST),e.scissor(this.clearArea[0],this.clearArea[1],this.clearArea[2],this.clearArea[3]),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.disable(e.SCISSOR_TEST)}else e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}}]),e}(TextSprite),PureBgSprite=function(t){function e(t){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return _inherits(e,t),_createClass(e,[{key:"drawStatic",value:function(){this.clear();var t=this.ctx,e=config.backgroundMap[config.state.backgroundIndex].colors[config.state.bgColorIndex];t.fillStyle=e,t.fillRect(0,0,t.canvas.width,t.canvas.height)}},{key:"drawFrame",value:function(){this.drawStatic()}},{key:"advance",value:function(t){var e=!0;return e}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}}]),e}(BgSprite),TreeBgSprite=function(t){function e(t){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return _inherits(e,t),_createClass(e,[{key:"init",value:function(){this.initGl()}},{key:"drawStatic",value:function(){this.clear();var t=config.backgroundMap[config.state.backgroundIndex].colors[config.state.bgColorIndex];this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.renderGlMoon({pos:{x:150,y:150},r:70,t:1,numTimesToSubdivide:5}),this.renderGlTree({pos:{x:this.ctx.canvas.width-350,y:this.ctx.canvas.height},theta:.2,minH:20,iniH:35}),this.renderGlTree({pos:{x:this.ctx.canvas.width-200,y:this.ctx.canvas.height},theta:.2,minH:20,iniH:50})}},{key:"drawFrame",value:function(){this.clear();var t=config.backgroundMap[config.state.backgroundIndex].colors[config.state.bgColorIndex];this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.renderGlMoon({pos:{x:150,y:150},r:70,t:this._t,numTimesToSubdivide:5}),this.renderGlTree({pos:{x:this.ctx.canvas.width-350,y:this.ctx.canvas.height},theta:.2*this._t,minH:20,iniH:35}),this.renderGlTree({pos:{x:this.ctx.canvas.width-200,y:this.ctx.canvas.height},theta:.2*this._t,minH:20,iniH:50})}},{key:"advance",value:function(t){var e=!0;if(this.t=t,this._t<1){var n=this.options.duration,i=t/n;this._t=Math.pow(i,1),e=!1}return e&&this.stop(),e}},{key:"stop",value:function(){this.animating=!1,this._t=0}},{key:"initGl",value:function(){var t=this.gl;this.vertexMoonShader=initGlShader(t,"attribute vec4 vPosition;\n      attribute vec4 vNormal;\n      attribute float compIdx;\n\n      varying vec4 fColor;\n\n      uniform float t;\n      uniform float compNum;\n      uniform vec3 vColor;\n\n      uniform vec4 ambientProduct, diffuseProduct, specularProduct;\n      uniform mat4 modelViewMatrix;\n      uniform vec4 lightPosition;\n      uniform float shininess;\n      uniform mat3 normalMatrix;\n\n      void main() {\n        vec3 pos = (modelViewMatrix * vPosition).xyz;\n\n        vec3 L;\n        \n        if(lightPosition.w == 0.0) L = normalize(lightPosition.xyz);\n        else L = normalize( lightPosition.xyz - pos );\n         \n        vec3 E = -normalize( pos );\n        \n        vec3 H = normalize( L + E );\n        \n        vec3 N = normalize( normalMatrix*vNormal.xyz);\n\n        vec4 ambient = ambientProduct;\n\n        float Kd = max( dot(L, N), 0.0 );\n        vec4  diffuse = Kd*diffuseProduct;\n\n        float Ks = pow( max(dot(N, H), 0.0), shininess );\n        vec4  specular = Ks * specularProduct;\n        \n        if( dot(L, N) < 0.0 ) {\n          specular = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n\n        gl_PointSize = 1.0;\n        gl_Position = modelViewMatrix * vPosition;\n\n        fColor = ambient + diffuse +specular;\n        fColor.a = 1.0;\n\n        if (dot(N, L) < 0.0) {\n          fColor = vec4(1.0, 1.0, 0.9 - 0.2 * t, 1.0);\n        } else if (dot(N, L) < 0.8 + t * 0.09 ) {\n          fColor = vec4(1.0, 1.0, 0.9 - 0.1 * t, 1.0);\n        } else {\n          fColor = vec4(1.0, 1.0, 0.9 + 0.05 * t, 1.0);\n        }\n      }",t.VERTEX_SHADER),
this.fragmentMoonShader=initGlShader(t,"precision mediump float;\n\n      varying vec4 fColor;\n\n      void main() {\n        gl_FragColor = fColor;\n      }",t.FRAGMENT_SHADER),this.moonProgram=initGlProgram(t,[this.vertexMoonShader,this.fragmentMoonShader]),this.vertexTreeShader=initGlShader(t,"attribute vec2 vPosition;\n\n      varying vec4 fColor;\n\n      void main() {\n        gl_PointSize = 1.0;\n        gl_Position = vec4(vPosition, 0.0, 1.0);\n\n        fColor = vec4(0.8156862745098039, 0.8470588235294118, 0.8313725490196079, 1.0);\n      }",t.VERTEX_SHADER),this.fragmentTreeShader=initGlShader(t,"precision mediump float;\n\n      varying vec4 fColor;\n\n      void main() {\n        gl_FragColor = fColor;\n      }",t.FRAGMENT_SHADER),this.treeProgram=initGlProgram(t,[this.vertexTreeShader,this.fragmentTreeShader])}},{key:"renderGlTree",value:function(t){function e(t,i,a,s){var h={x:0-i*Math.abs(Math.sin(s)),y:i*Math.abs(Math.cos(s))},c={x:i*Math.abs(Math.sin(s)),y:i*Math.abs(Math.cos(s))},l=h.x*Math.cos(-a)-h.y*Math.sin(-a),u=h.x*Math.sin(-a)+h.y*Math.cos(-a);h.x=l+t.x,h.y=u+t.y,l=c.x*Math.cos(-a)-c.y*Math.sin(-a),u=c.x*Math.sin(-a)+c.y*Math.cos(-a),c.x=l+t.x,c.y=u+t.y,n.push(vec2(t.x,t.y)),n.push(vec2(h.x,h.y)),n.push(vec2(t.x,t.y)),n.push(vec2(c.x,c.y)),r++,i>=o&&(e(h,5*i/6,a-s,5*s/6),e(c,5*i/6,a+s,5*s/6))}var n=[],i=t.pos,a=t.theta,r=0,o=2*t.minH/this.ctx.canvas.height,s=this.gl,h=2*t.iniH/700;n.push(vec2(0,-1)),n.push(vec2(0,-1+h)),e({x:0,y:-1+h},5*h/6,0,5*a/6);var c=this.treeProgram;s.useProgram(c),s.enable(s.DEPTH_TEST),s.viewport(i.x-this.ctx.canvas.width/2,0,this.ctx.canvas.width,this.ctx.canvas.height);var l=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,l),s.bufferData(s.ARRAY_BUFFER,flatten(n),s.STATIC_DRAW);var u=s.getAttribLocation(c,"vPosition");s.vertexAttribPointer(u,2,s.FLOAT,!1,0,0),s.enableVertexAttribArray(u),s.drawArrays(s.LINES,0,n.length)}},{key:"renderGlMoon",value:function(t){function e(t,e,n){x.push(t),x.push(e),x.push(n),m.push(t[0],t[1],t[2],0),m.push(e[0],e[1],e[2],0),m.push(n[0],n[1],n[2],0)}function n(t,i,a,r){if(r>0){var o=mix(t,i,.5),s=mix(t,a,.5),h=mix(i,a,.5);o=normalize(o,!0),s=normalize(s,!0),h=normalize(h,!0),n(t,o,s,r-1),n(o,i,h,r-1),n(h,a,s,r-1),n(o,h,s,r-1)}else e(t,i,a)}function i(t,e,i,a,r){n(t,e,i,r),n(a,i,e,r),n(t,a,e,r),n(t,i,a,r)}var a=t.t,r=t.pos,o=t.r,s=t.numTimesToSubdivide||5;a>=1&&(a=1);var h,c,l,u,f,d=.1,v=.5+.2*a,g=this.gl,p=this.moonProgram,x=[],m=[],y=.5,v=.7,d=.1,b=vec4(0,0,-1,1),w=vec4(0,.942809,.333333,1),S=vec4(-.816497,-.471405,.333333,1),C=vec4(.816497,-.471405,.333333,1),k=vec4(1,1,1,0),T=vec4(1,1,1,1),_=vec4(1,1,1,1),A=vec4(1,1,1,1),M=vec4(1,1,.7,1),I=vec4(.7,.7,.7,1),$=vec4(1,1,1,1),R=20,E=vec3(0,0,0),B=vec3(0,1,0);g.useProgram(p),g.enable(g.DEPTH_TEST),g.viewport(r.x-o,this.ctx.canvas.height-(r.y+o),2*o,2*o);var P=mult(T,M),N=mult(_,I),F=mult(A,$);i(b,w,S,C,s);var L=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,L),g.bufferData(g.ARRAY_BUFFER,flatten(m),g.STATIC_DRAW);var H=g.getAttribLocation(p,"vNormal");g.vertexAttribPointer(H,4,g.FLOAT,!1,0,0),g.enableVertexAttribArray(H);var z=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,z),g.bufferData(g.ARRAY_BUFFER,flatten(x),g.STATIC_DRAW);var D=g.getAttribLocation(p,"vPosition");g.vertexAttribPointer(D,4,g.FLOAT,!1,0,0),g.enableVertexAttribArray(D),c=g.getUniformLocation(p,"modelViewMatrix"),u=g.getUniformLocation(p,"normalMatrix"),g.uniform4fv(g.getUniformLocation(p,"ambientProduct"),flatten(P)),g.uniform4fv(g.getUniformLocation(p,"diffuseProduct"),flatten(N)),g.uniform4fv(g.getUniformLocation(p,"specularProduct"),flatten(F)),g.uniform4fv(g.getUniformLocation(p,"lightPosition"),flatten(k)),g.uniform1f(g.getUniformLocation(p,"shininess"),R),g.uniform1f(g.getUniformLocation(p,"t"),a),f=vec3(y*Math.sin(v)*Math.cos(d),y*Math.sin(v)*Math.sin(d),y*Math.cos(v)),h=lookAt(f,E,B),l=[vec3(h[0][0],h[0][1],h[0][2]),vec3(h[1][0],h[1][1],h[1][2]),vec3(h[2][0],h[2][1],h[2][2])],g.uniformMatrix4fv(c,!1,flatten(h)),g.uniformMatrix3fv(u,!1,flatten(l)),g.drawArrays(g.TRIANGLES,0,x.length)}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}}]),e}(BgSprite),Data=function(){function t(e,n){_classCallCheck(this,t),this._content=[],this.editor=e,this._lines=[],n&&this.addContent(0,n)}return _createClass(t,[{key:"addContent",value:function(t,e){window._text=e;for(var n=0;n<e.length;n++)this._content.splice(t,0,e.charAt(n)),t++;this._lines=this._content.join("").split("\n")}},{key:"deleteContent",value:function(t,e){var n=this._content.splice(t-e,e);return this._lines=this._content.join("").split("\n"),n.join("")}},{key:"getContent",value:function(t,e){return 0===arguments.length?this._content.join():this._content.slice(t,t+e)}},{key:"getLength",value:function(){return this._content.length}},{key:"getLines",value:function(){return this._lines}},{key:"getLine",value:function(t){return this._lines[t]}}]),t}(),Editor=function(){function t(e){_classCallCheck(this,t),this.options={paddingLeft:120,paddingRight:120,paddingTop:65,paddingBottom:65,bottomBarHeight:68},this.onFocus=!1,this.isToolBarShown=!1,this.toolBarWidth=200,this.operations=[],this.init()}return _createClass(t,[{key:"init",value:function(){this.createStyle(),this.initData(),this.selection=new Selection(this),this.createElements(),this.bindEvents(),this.createMap(),this.style.initSprites()}},{key:"resize",value:function(){var t=$(window).width(),e=$(window).height(),n=$(this.editorNode),i=t>800?t-this.options.paddingLeft-this.options.paddingRight:t-50,a=t>800?e-this.options.bottomBarHeight-this.options.paddingTop-this.options.paddingBottom:e-135;n.css("width",i+"px"),n.css("height",a+"px"),n.css("top",(e-a-this.options.bottomBarHeight)/2+"px"),this.canvasNode.width=i,this.canvasNode.height=a,this.isToolBarShown&&t>800?this.updateRelativeLocation((e-a-this.options.bottomBarHeight)/2,this.toolBarWidth+(t-this.toolBarWidth-i)/2):this.updateRelativeLocation((e-a-75)/2,(t-i)/2),this.renderText()}},{key:"showToolBar",value:function(){var t=$(window).width(),e=$(window).height(),n=t>800?t-this.options.paddingLeft-this.options.paddingRight:t-50,i=t>800?e-this.options.bottomBarHeight-this.options.paddingTop-this.options.paddingBottom:e-135;this.isToolBarShown=!0,this.updateRelativeLocation((e-i-this.options.bottomBarHeight)/2,this.toolBarWidth+(t-this.toolBarWidth-n)/2)}},{key:"hideToolBar",value:function(){var t=$(window).width(),e=$(window).height(),n=t>800?t-this.options.paddingLeft-this.options.paddingRight:t-50,i=t>800?e-this.options.bottomBarHeight-this.options.paddingTop-this.options.paddingBottom:e-135;this.isToolBarShown=!1,this.updateRelativeLocation((e-i-this.options.bottomBarHeight)/2,(t-n)/2)}},{key:"updateRelativeLocation",value:function(t,e){this.top=t,this.left=e}},{key:"createStyle",value:function(){this.style=new Style(this)}},{key:"createElements",value:function(){var t=$(window).width(),e=$(window).height(),n=t>800?t-this.options.paddingLeft-this.options.paddingRight:t-50,i=t>800?e-this.options.bottomBarHeight-this.options.paddingTop-this.options.paddingBottom:e-135;this.$editor=$("#editor"),this.editorNode=this.$editor.get(0),this.$editor.css("overflow","hidden"),this.$editor.css("position","relative"),this.$editor.css("box-shadow","1px 1px 3px 1px #bbb"),this.$editor.css("margin","auto"),this.$editor.css("width",n+"px"),this.$editor.css("height",i+"px"),this.$editor.css("top",(e-i-this.options.bottomBarHeight)/2+"px"),this.$editor.css("background-color","rgb(241, 240, 236)"),this.hiddenCanvas=document.createElement("canvas"),this.hiddenCtx=this.hiddenCanvas.getContext("2d"),this.hiddenCanvas.width=this.style.lineHeight(),this.hiddenCanvas.height=this.style.lineHeight(),this.$bgCanvas=$("#bg-canvas"),this.$bgGlcanvas=$("#bg-glcanvas"),this.bgGlcanvasNode=this.$bgGlcanvas.get(0),this.bgCanvasNode=this.$bgCanvas.get(0),this.bgCtx=this.bgCanvasNode.getContext("2d"),this.bgCanvasNode.width=n,this.bgCanvasNode.height=i,this.bgGlcanvasNode.width=n,this.bgGlcanvasNode.height=i,this.bgGl=this.bgGlcanvasNode.getContext("webgl",{preserveDrawingBuffer:!0}),this.$canvas=$("#text-canvas"),this.$glcanvas=$("#text-glcanvas"),this.glcanvasNode=this.$glcanvas.get(0),this.canvasNode=this.$canvas.get(0),this.ctx=this.canvasNode.getContext("2d"),this.canvasNode.width=n,this.canvasNode.height=i,this.glcanvasNode.width=n,this.glcanvasNode.height=i,this.gl=this.glcanvasNode.getContext("webgl",{preserveDrawingBuffer:!0}),this.$input=$("<textarea>"),this.inputNode=this.$input.get(0),this.$input.css("position","absolute"),this.$input.css("top",i/5+"px"),this.$input.css("left",n/2-100+"px"),this.$input.css("width",n+"px"),this.$input.css("height","20px"),this.$input.css("z-index","-1000"),this.$editor.append(this.$input),this.$cursor=$('<div class="cursor"></div>'),this.cursorNode=this.$cursor.get(0),this.$cursor.css("width","1px"),this.$cursor.css("height",this.style.lineHeight()+"px"),this.$cursor.css("position","absolute"),this.$cursor.css("top",this.selection.rowIndex*this.style.lineHeight()),this.$cursor.css("left",this.selection.colIndex*this.fontSize),this.$cursor.css("background-color","black"),this.$editor.append(this.$cursor),this.hideCursor(),this.updateRelativeLocation((e-i-this.options.bottomBarHeight)/2,(t-n)/2)}},{key:"updateCursor",value:function(){var t=this.selection.getSelEndPosition();this.$cursor.css("height",this.style.lineHeight()+"px"),this.$cursor.css("left",this.map[t.rowIndex][t.colIndex].cursorX+"px"),this.$cursor.css("top",this.map[t.rowIndex][t.colIndex].cursorY+"px")}},{key:"initData",value:function(){this.data=new Data(this)}},{key:"bindEvents",value:function(){this.$input.on("change",this.onInputChange.bind(this)),this.$input.on("focus",this.onInputFocus.bind(this)),this.$input.on("blur",this.onInputBlur.bind(this)),this.$input.on("keydown",this.onKeyDown.bind(this)),this.$input.on("compositionstart",this.onCompStart.bind(this)),this.$input.on("compositionend",this.onCompEnd.bind(this)),this.$input.on("input",this.onInputChar.bind(this)),this.$editor.on("touchstart",this.onTouchStart.bind(this)),this.$editor.on("touchend",this.onTouchEnd.bind(this)),this.$editor.on("mousedown",this.onMouseDown.bind(this)),this.$editor.on("mouseup",this.onMouseUp.bind(this)),$("body").on("click touchend",this.onGlobalClick.bind(this)),$(window).on("resize",this.resize.bind(this)),$(window).on("scroll",this.onScroll.bind(this))}},{key:"findPosfromMap",value:function(t,e){if(0===this.map.length)return{col:0,row:0};var n,i,a=this.map,r=(this.map.length-1,this.style.fontSize),o=this.style.lineHeight(),s={row:0,col:0};for(n=0;n<a.length;n++)for(i=0;i<a[n].length;i++)if(Math.abs(t-a[n][i].cursorX)<r/2&&e>a[n][i].cursorY&&e<a[n][i].cursorY+o)return s={row:n,col:i};return s}},{key:"clearInputNodeValue",value:function(){this.inputNode.value=""}},{key:"onKeyDown",value:function(t){switch(t.keyCode){case 8:if(this.map[0].length<=1&&this.map.length<=1)return;this.deleteText(this.selection.getSelEndPosition().index,this.selection.getSelLength()||1),this.clearInputNodeValue(),this.selection.update(this.selection.getSelEndPosition().index-1),this.renderText();break;case 37:this.selection.update(this.selection.getSelEndPosition().index-1),this.updateCursor();break;case 38:break;case 39:this.selection.update(this.selection.getSelEndPosition().index+1),this.updateCursor();break;case 40:}}},{key:"insertText",value:function(t,e){this.data.addContent(t,e),this.selection.update(t+e.length),this.operations.push({action:t>=this.data.getLength()?"add":"insert",index:t,text:e})}},{key:"deleteText",value:function(t,e){var n=this.data.deleteContent(t,e);this.operations.push({action:"delete",index:t,text:n})}},{key:"clearText",value:function(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}},{key:"clearCanvas",value:function(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.bgCtx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.bgGl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}},{key:"createMap",value:function(){this.map=[[{"char":"",x:this.style.padding[3],y:this.style.padding[0],cursorX:"center"===this.style.textAlign?this.canvasNode.width/2:this.style.padding[3],cursorY:this.style.padding[0]}]]}},{key:"_convertWindowPosToCanvas",value:function(t,e){var n=($(window).width(),$(window).height(),t-this.left),i=e-this.top;return(n<0||n>this.canvasNode.width||i<0||i>this.canvasNode.height)&&(n=-1,i=-1),{x:n,y:i}}},{key:"_convertCanvasPosToWindow",value:function(t,e){var n=($(window).width(),$(window).height(),t+this.left),i=e+this.top;return{x:n,y:i}}},{key:"onGlobalClick",value:function(t){var e=this._convertWindowPosToCanvas(t.clientX,t.clientY);e.x===-1&&e.y===-1&&this.blur()}},{key:"onInputChange",value:function(t){}},{key:"onInputBlur",value:function(t){this.inputStatus="NULL"}},{key:"onInputFocus",value:function(t){}},{key:"onCompStart",value:function(t){this.inputStatus="CHINESE_TYPING"}},{key:"onCompEnd",value:function(t){var e=this;setTimeout(function(){e.input(),e.inputStatus="CHINESE_TYPE_END"},100)}},{key:"onInputChar",value:function(t){"CHINESE_TYPING"!==this.inputStatus&&(this.inputStatus="CHAR_TYPING",this.input())}},{key:"onScroll",value:function(t){this.touch={},this.click={}}},{key:"input",value:function(t){this.insertText(this.selection.getSelEndPosition().index,this.inputNode.value),this.clearInputNodeValue(),this.renderText()}},{key:"onMouseUp",value:function(t){t.preventDefault();if(this.click){var e=this._convertWindowPosToCanvas(t.clientX,t.clientY);e.x!==-1&&e.y!==-1?this.focus(e.x,e.y):this.blur()}this.click={}}},{key:"onMouseDown",value:function(t){this.click={x:t.clientX,y:t.clientY}}},{key:"onTouchStart",value:function(t){this.touch=t.touches[0]}},{key:"onTouchEnd",value:function(t){t.preventDefault();if(this.touch){var e=this._convertWindowPosToCanvas(t.changedTouches[0].clientX,t.changedTouches[0].clientY);e.x!==-1&&e.y!==-1?this.focus(e.x,e.y):this.blur()}this.touch={}}},{key:"hideCursor",value:function(){this.$cursor.css("visibility","hidden")}},{key:"blur",value:function(){this.hideCursor(),this.inputNode.blur(),this.onFocus=!1}},{key:"focus",value:function(t,e){var n=this.findPosfromMap(t,e);this.selection.update(n.row,n.col),this.updateCursor(),this.$input.focus(),this.$cursor.css("visibility","visible"),this.onFocus=!0}},{key:"updateMap",value:function(t){this.map=t}},{key:"measureStrLength",value:function(t){var e=0,n=t.split("");return n.forEach(function(t){if(t){var n=t.charCodeAt(0);e+=n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122?.5:1}}),e}},{key:"renderText",value:function(){this.bgSprite.drawStatic();var t=this.style.padding[3],e=this.style.padding[0],n=[],i=this.data.getLines();switch(0===i.length&&i.push(""),this.ctx.font=this.style.fontSize+"px serif",this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.style.textAlign){case"left":for(var a=0;a<i.length;a++){var r=[],o=this.style.fontSize;t=this.style.padding[3];var s=i[a].split("");r.push({"char":"",x:t,y:e,cursorX:t,cursorY:e});for(var h=0;h<s.length;h++){var c=o;t+=o,r.push({"char":s[h],x:t-c,y:e,cursorX:t,cursorY:e}),h+1<s.length&&t+c>this.canvasNode.width-this.style.padding[1]-this.style.padding[3]&&(e+=this.style.lineHeight(),t=this.style.padding[3])}n.push(r),e+=this.style.lineHeight(),e+=this.style.space}break;case"center":for(var a=0;a<i.length;a++){var r=[],s=i[a].split(""),o=this.style.fontSize,l=o*s.length;for(t=l>this.canvasNode.width-this.style.padding[0]-this.style.padding[3]?this.style.padding[3]:(this.canvasNode.width-this.style.padding[0]-this.style.padding[3]-l)/2+this.style.padding[3],r.push({"char":"",x:t,y:e,cursorX:t,cursorY:e});l>this.canvasNode.width-this.style.padding[0]-this.style.padding[3];){t=this.style.padding[3];for(var h=0;h<s.length;h++){var c=o;if(t+=c,r.push({"char":s[h],x:t-c,y:e,cursorX:t,cursorY:e}),h+1<s.length&&t+c>this.canvasNode.width-this.style.padding[1]){e+=this.style.lineHeight(),s.splice(0,h+1),l=o*s.length;break}}}if(l)for(t=(this.canvasNode.width-this.style.padding[0]-this.style.padding[3]-l)/2+this.style.padding[3],h=0;h<s.length;h++){var c=o;t+=c,r.push({"char":s[h],x:t-c,y:e,cursorX:t,cursorY:e})}n.push(r),e+=this.style.lineHeight(),e+=this.style.space}}this.updateMap(n),this.textSprite.update(),this._fillText(),this.updateCursor()}},{key:"_fillText",value:function(){1===this.map.length&&1===this.map[0].length?this.textSprite.clear():setTimeout(this.textSprite.drawStatic.bind(this.textSprite),10)}},{key:"play",value:function(){this.animating=!0,this.animationInfo={textStop:!1,bgStop:!1},this.startTime=Date.now(),this.textSprite.update(),this.bgSprite.update(),window.requestAnimationFrame(this.tick.bind(this))}},{key:"tick",value:function(){if(this.animating){var t=Date.now()-this.startTime;!this.animationInfo.textStop&&(this.animationInfo.textStop=this.textSprite.advance(t)),!this.animationInfo.bgStop&&(this.animationInfo.bgStop=this.bgSprite.advance(t)),this.animationInfo.textStop&&this.animationInfo.bgStop?this.stopPlay():(this.animationInfo.bgStop?this.bgSprite.drawStatic():this.bgSprite.drawFrame(),this.animationInfo.textStop?this.textSprite.drawStatic():this.textSprite.drawFrame(),window.requestAnimationFrame(this.tick.bind(this)))}}},{key:"stopPlay",value:function(){this.animating=!1,this.renderText(),bottomBar.config.$dom.find(".play").removeClass("stop")}},{key:"generateGif",value:function(){}},{key:"generateJpeg",value:function(){var t=document.createElement("canvas");t.width=this.canvasNode.width,t.height=this.canvasNode.height;var e=t.getContext("2d");e.drawImage(this.bgCanvasNode,0,0),e.drawImage(this.bgGlcanvasNode,0,0),e.drawImage(this.canvasNode,0,0),e.drawImage(this.glcanvasNode,0,0);var n=t.toDataURL("image/jpeg",1);return n}},{key:"generatePng",value:function(){var t=document.createElement("canvas");t.width=this.canvasNode.width,t.height=this.canvasNode.height;var e=t.getContext("2d");e.drawImage(this.bgCanvasNode,0,0),e.drawImage(this.bgGlcanvasNode,0,0),e.drawImage(this.canvasNode,0,0),e.drawImage(this.glcanvasNode,0,0);var n=t.toDataURL("image/png");return n}}]),t}(),Selection=function(){function t(e){_classCallCheck(this,t),this.editor=e,this.startColIndex=this.endColIndex=0,this.startRowIndex=this.endRowIndex=0}return _createClass(t,[{key:"getSelEndPosition",value:function(){return{colIndex:this.endColIndex,rowIndex:this.endRowIndex,index:this._convertIndexByMap(this.endRowIndex,this.endColIndex)}}},{key:"getSelLength",value:function(){return 0}},{key:"update",value:function(t,e,n,i){if(1===arguments.length){var a=arguments[0];if(a>this.editor.data.getLength()||a<0)return;this.index=a;var r=this._convertMapByIndex(a);this.startColIndex=this.endColIndex=r.col,this.startRowIndex=this.endRowIndex=r.row}else 2===arguments.length&&(this.startColIndex=this.endColIndex=e,this.startRowIndex=this.endRowIndex=t)}},{key:"_convertIndexByMap",value:function(t,e){for(var n=this.editor.data.getLines(),i=0,a=0;a<n.length;a++)a<t?i+=n[a].length+1:a===t&&(i+=e);return i}},{key:"_convertMapByIndex",value:function(t){for(var e=this.editor.data.getLines(),n=0,i=0,a=0;a<e.length;a++){if(!(t>e[a].length)){i=t;break}t-=e[a].length+1,n++}return{row:n,col:i}}}]),t}(),Style=function(){function t(e){_classCallCheck(this,t),this.editor=e,this.initDefaultStyle()}return _createClass(t,[{key:"changeStyle",value:function(t){for(var e=Object.keys(t),n=0;n<e.length;n++)this[e[n]]=t[e[n]],"textStyle"===e[n]&&this.changeTextStyle(t[e[n]]),"background"===e[n]&&this.changeBgStyle(t[e[n]]);this.editor.hiddenCanvas&&(this.editor.hiddenCanvas.width=this.lineHeight(),this.editor.hiddenCanvas.height=this.lineHeight())}},{key:"changeTextStyle",value:function(t){this.editor.textSprite=util.getSpriteEntity(config.textStyleMap[t].Klass,this.editor),this.editor.textSprite.changeTextStyle(config.textStyleMap[t].style),config.animationMap=this.editor.textSprite.getAnimationMap(),this.editor.textSprite.update()}},{key:"changeBgStyle",value:function(t){this.editor.bgSprite=util.getSpriteEntity(config.backgroundMap[t].Klass,this.editor),this.editor.bgSprite.update()}},{key:"lineHeight",value:function(){return this.lineHeightRatio*this.fontSize}},{key:"initDefaultStyle",value:function(){this.changeStyle({textAlign:util.getInitialState("textAlign"),fontSize:util.getInitialState("fontSize"),lineHeightRatio:1.2,textWeight:800,padding:[80,50,50,80],space:20,animation:util.getInitialState("animation"),fontColor:util.getInitialState("fontColor")})}},{key:"initSprites",value:function(){this.changeStyle({textStyle:util.getInitialState("textStyle"),background:util.getInitialState("background")})}}]),t}(),bottomBar={config:{$dom:$(".bottom-bar")},init:function(){this.bindEvents()},bindEvents:function(){var t=this;t.config.$dom.find(".export").on("click touchend",function(t){selectModal.show()}),t.config.$dom.find(".play").on("touchend click",function(t){$(this).hasClass("stop")?(editor.stopPlay(),$(this).removeClass("stop")):(editor.play(),$(this).addClass("stop"))}),t.config.$dom.find(".tool").on("touchend click",function(t){toolBar.config.isShown?(toolBar.hide(editor),$(this).find(".label").text("工具栏")):(toolBar.show(editor),$(this).find(".label").text("隐藏"))})}},resultModal={config:{$dom:$(".export-result-modal")},init:function(){this.bindEvents()},bindEvents:function(){var t=this;t.config.$dom.find(".dim-layer").on("click touchend",function(e){t.hide()})},show:function(t){this.config.$dom.find("img").attr("src",t),this.config.$dom.addClass("show")},hide:function(){this.config.$dom.removeClass("show")}},selectModal={config:{$dom:$(".export-select-modal"),selection:"jpeg"},init:function(){this.bindEvents()},bindEvents:function(){var t=this;t.config.$dom.find(".item").on("click touchend",function(e){t.config.selection=$(this).text().toLowerCase(),t.config.$dom.find(".item").removeClass("active"),$(this).addClass("active")}),t.config.$dom.find(".confirm").on("click touchend",function(e){t.hide(),t["export"](t.config.selection)}),t.config.$dom.find(".cancel").on("click touchend",function(e){t.hide()})},show:function(){this.config.$dom.addClass("show")},hide:function(){this.config.$dom.removeClass("show")},"export":function(t){var e;switch(t){case"jpeg":e=editor.generateJpeg(),resultModal.show(e);break;case"png":e=editor.generatePng(),resultModal.show(e);break;case"gif":editor.generateGif().then(function(t){resultModal.show(t)})}}},toolBar={config:{isShown:!1},init:function(){this.onChange=!1,this.config.$dom.find(".tool-bar-item").each(function(){var t=$(this).classes(),e=/i-(.*)/i;$(this).find(".value").append('<span class="spinner-icon"></span>'),$(this).find(".spinner-icon").hide(),t.forEach(function(t){if(e.test(t)){var n=RegExp.$1;toolBar.update(n)}})}),this.updateBgColor(),this.bindEvents()},bindEvents:function(){var t=this;t.config.$dom.find(".tool-bar-item .value").on("click touchend",function(e){var n=$(this).parent().classes(),i=$(this),a=/i-(.*)/i;n.forEach(function(e){if(a.test(e)){var n=RegExp.$1;t[n+"OnChange"]||(i.find(".spinner-icon").show(),toolBar.changeStyle(n))}})}),t.config.$dom.find(".close-icon").on("touchend click",function(e){t.hide(editor),bottomBar.config.$dom.find(".label").text("工具栏")}),t.config.$dom.find(".color-switch").on("touchend click",function(e){t.changeBgColor()})},hide:function(t){$(".wrapper").removeClass("show-tool-bar"),$(".wrapper").addClass("hide-tool-bar"),t.hideToolBar(),this.config.isShown=!1},show:function(t){$(".wrapper").hasClass("default")?$(".wrapper").removeClass("default"):$(".wrapper").removeClass("hide-tool-bar"),$(".wrapper").addClass("show-tool-bar"),t.showToolBar(),this.config.isShown=!0},nextIndex:function(t){var e=config.state[t+"Index"],n=config[t+"Map"];return e<n.length-1?config.state[t+"Index"]+=1:config.state[t+"Index"]=0,config.state[t+"Index"]},changeStyle:function(t){this.nextIndex(t);this.update(t)},update:function(t){this[t+"OnChange"]=!0;var e=config.state[t+"Index"],n=config[t+"Map"][e],i=n.value,a=n.label,r={};r[t]=i,$(".i-"+t+" .value .text").text(a);var o=this;editor.style.changeStyle(r),this[t+"Change"]&&"function"==typeof this[t+"Change"]&&this[t+"Change"].call(this,n),editor.clearCanvas(),editor.renderText(),setTimeout(function(t,e){o[t+"OnChange"]=!1,$(".i-"+t+" .value .text").text(e),$(".i-"+t+" .value .spinner-icon").hide()},500,t,a)},textStyleChange:function(t){config.state.animationIndex=0,this.update("animation")},backgroundChange:function(t){var e=t.colors;0===e.length?($(".color-switch").hide(),config.state.bgColorIndex=null):($(".color-switch").css("background-color",e[0]).show(),config.state.bgColorIndex=0)},changeBgColor:function(){var t=config.backgroundMap[config.state.backgroundIndex].colors,e=config.state.bgColorIndex;e=e+1>=t.length?0:++e,config.state.bgColorIndex=e,this.updateBgColor()},updateBgColor:function(){editor.renderText();var t=config.backgroundMap[config.state.backgroundIndex].colors,e=config.state.bgColorIndex;$(".color-switch").css("background-color",t[e])}};toolBar.config.$dom=$(".tool-bar-wrap"),function e(t,n,i){function a(o,s){if(!n[o]){if(!t[o]){var h="function"==typeof require&&require;if(!s&&h)return h(o,!0);if(r)return r(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return a(n?n:e)},l,l.exports,e,t,n,i)}return n[o].exports}for(var r="function"==typeof require&&require,o=0;o<i.length;o++)a(i[o]);return a}({1:[function(t,e,n){window.earcut=t("earcut"),window.editor=new Editor({}),toolBar.init(),bottomBar.init(),resultModal.init(),selectModal.init()},{earcut:2}],2:[function(t,e,n){function i(t,e,n){n=n||2;var i=e&&e.length,r=i?e[0]*n:t.length,s=a(t,0,r,n,!0),h=[];if(!s)return h;var c,l,f,d,v,g,p;if(i&&(s=u(t,e,s,n)),t.length>80*n){c=f=t[0],l=d=t[1];for(var x=n;x<r;x+=n)v=t[x],g=t[x+1],v<c&&(c=v),g<l&&(l=g),v>f&&(f=v),g>d&&(d=g);p=Math.max(f-c,d-l)}return o(s,h,n,c,l,p),h}function a(t,e,n,i,a){var r,o;if(a===R(t,e,n,i)>0)for(r=e;r<n;r+=i)o=M(r,t[r],t[r+1],o);else for(r=n-i;r>=e;r-=i)o=M(r,t[r],t[r+1],o);return o&&S(o,o.next)&&(I(o),o=o.next),o}function r(t,e){if(!t)return t;e||(e=t);var n,i=t;do if(n=!1,i.steiner||!S(i,i.next)&&0!==w(i.prev,i,i.next))i=i.next;else{if(I(i),i=e=i.prev,i===i.next)return null;n=!0}while(n||i!==e);return e}function o(t,e,n,i,a,u,f){if(t){!f&&u&&g(t,i,a,u);for(var d,v,p=t;t.prev!==t.next;)if(d=t.prev,v=t.next,u?h(t,i,a,u):s(t))e.push(d.i/n),e.push(t.i/n),e.push(v.i/n),I(t),t=v.next,p=v.next;else if(t=v,t===p){f?1===f?(t=c(t,e,n),o(t,e,n,i,a,u,2)):2===f&&l(t,e,n,i,a,u):o(r(t),e,n,i,a,u,1);break}}}function s(t){var e=t.prev,n=t,i=t.next;if(w(e,n,i)>=0)return!1;for(var a=t.next.next;a!==t.prev;){if(y(e.x,e.y,n.x,n.y,i.x,i.y,a.x,a.y)&&w(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}function h(t,e,n,i){var a=t.prev,r=t,o=t.next;if(w(a,r,o)>=0)return!1;for(var s=a.x<r.x?a.x<o.x?a.x:o.x:r.x<o.x?r.x:o.x,h=a.y<r.y?a.y<o.y?a.y:o.y:r.y<o.y?r.y:o.y,c=a.x>r.x?a.x>o.x?a.x:o.x:r.x>o.x?r.x:o.x,l=a.y>r.y?a.y>o.y?a.y:o.y:r.y>o.y?r.y:o.y,u=x(s,h,e,n,i),f=x(c,l,e,n,i),d=t.nextZ;d&&d.z<=f;){if(d!==t.prev&&d!==t.next&&y(a.x,a.y,r.x,r.y,o.x,o.y,d.x,d.y)&&w(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(d=t.prevZ;d&&d.z>=u;){if(d!==t.prev&&d!==t.next&&y(a.x,a.y,r.x,r.y,o.x,o.y,d.x,d.y)&&w(d.prev,d,d.next)>=0)return!1;d=d.prevZ}return!0}function c(t,e,n){var i=t;do{var a=i.prev,r=i.next.next;!S(a,r)&&C(a,i,i.next,r)&&T(a,r)&&T(r,a)&&(e.push(a.i/n),e.push(i.i/n),e.push(r.i/n),I(i),I(i.next),i=t=r),i=i.next}while(i!==t);return i}function l(t,e,n,i,a,s){var h=t;do{for(var c=h.next.next;c!==h.prev;){if(h.i!==c.i&&b(h,c)){var l=A(h,c);return h=r(h,h.next),l=r(l,l.next),o(h,e,n,i,a,s),void o(l,e,n,i,a,s)}c=c.next}h=h.next}while(h!==t)}function u(t,e,n,i){var o,s,h,c,l,u=[];for(o=0,s=e.length;o<s;o++)h=e[o]*i,c=o<s-1?e[o+1]*i:t.length,l=a(t,h,c,i,!1),l===l.next&&(l.steiner=!0),u.push(m(l));for(u.sort(f),o=0;o<u.length;o++)d(u[o],n),n=r(n,n.next);return n}function f(t,e){return t.x-e.x}function d(t,e){if(e=v(t,e)){var n=A(e,t);r(n,n.next)}}function v(t,e){var n,i=e,a=t.x,r=t.y,o=-(1/0);do{if(r<=i.y&&r>=i.next.y){var s=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(s<=a&&s>o){if(o=s,s===a){if(r===i.y)return i;if(r===i.next.y)return i.next}n=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!n)return null;if(a===o)return n.prev;var h,c=n,l=n.x,u=n.y,f=1/0;for(i=n.next;i!==c;)a>=i.x&&i.x>=l&&y(r<u?a:o,r,l,u,r<u?o:a,r,i.x,i.y)&&(h=Math.abs(r-i.y)/(a-i.x),(h<f||h===f&&i.x>n.x)&&T(i,t)&&(n=i,f=h)),i=i.next;return n}function g(t,e,n,i){var a=t;do null===a.z&&(a.z=x(a.x,a.y,e,n,i)),a.prevZ=a.prev,a.nextZ=a.next,a=a.next;while(a!==t);a.prevZ.nextZ=null,a.prevZ=null,p(a)}function p(t){var e,n,i,a,r,o,s,h,c=1;do{for(n=t,t=null,r=null,o=0;n;){for(o++,i=n,s=0,e=0;e<c&&(s++,i=i.nextZ,i);e++);for(h=c;s>0||h>0&&i;)0===s?(a=i,i=i.nextZ,h--):0!==h&&i?n.z<=i.z?(a=n,n=n.nextZ,s--):(a=i,i=i.nextZ,h--):(a=n,n=n.nextZ,s--),r?r.nextZ=a:t=a,a.prevZ=r,r=a;n=i}r.nextZ=null,c*=2}while(o>1);return t}function x(t,e,n,i,a){return t=32767*(t-n)/a,e=32767*(e-i)/a,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t|e<<1}function m(t){var e=t,n=t;do e.x<n.x&&(n=e),e=e.next;while(e!==t);return n}function y(t,e,n,i,a,r,o,s){return(a-o)*(e-s)-(t-o)*(r-s)>=0&&(t-o)*(i-s)-(n-o)*(e-s)>=0&&(n-o)*(r-s)-(a-o)*(i-s)>=0}function b(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!k(t,e)&&T(t,e)&&T(e,t)&&_(t,e)}function w(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function S(t,e){return t.x===e.x&&t.y===e.y}function C(t,e,n,i){return!!(S(t,e)&&S(n,i)||S(t,i)&&S(n,e))||w(t,e,n)>0!=w(t,e,i)>0&&w(n,i,t)>0!=w(n,i,e)>0}function k(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&C(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}function T(t,e){return w(t.prev,t,t.next)<0?w(t,e,t.next)>=0&&w(t,t.prev,e)>=0:w(t,e,t.prev)<0||w(t,t.next,e)<0}function _(t,e){var n=t,i=!1,a=(t.x+e.x)/2,r=(t.y+e.y)/2;do n.y>r!=n.next.y>r&&a<(n.next.x-n.x)*(r-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next;while(n!==t);return i}function A(t,e){var n=new $(t.i,t.x,t.y),i=new $(e.i,e.x,e.y),a=t.next,r=e.prev;return t.next=e,e.prev=t,n.next=a,a.prev=n,i.next=n,n.prev=i,r.next=i,i.prev=r,i}function M(t,e,n,i){var a=new $(t,e,n);return i?(a.next=i.next,a.prev=i,i.next.prev=a,i.next=a):(a.prev=a,a.next=a),a}function I(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function $(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function R(t,e,n,i){for(var a=0,r=e,o=n-i;r<n;r+=i)a+=(t[o]-t[r])*(t[r+1]+t[o+1]),o=r;return a}e.exports=i,i.deviation=function(t,e,n,i){var a=e&&e.length,r=a?e[0]*n:t.length,o=Math.abs(R(t,0,r,n));if(a)for(var s=0,h=e.length;s<h;s++){var c=e[s]*n,l=s<h-1?e[s+1]*n:t.length;o-=Math.abs(R(t,c,l,n))}var u=0;for(s=0;s<i.length;s+=3){var f=i[s]*n,d=i[s+1]*n,v=i[s+2]*n;u+=Math.abs((t[f]-t[v])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[v+1]-t[f+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},i.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},i=0,a=0;a<t.length;a++){for(var r=0;r<t[a].length;r++)for(var o=0;o<e;o++)n.vertices.push(t[a][r][o]);a>0&&(i+=t[a-1].length,n.holes.push(i))}return n}},{}]},{},[1]);
//# sourceMappingURL=scripts.js.map
